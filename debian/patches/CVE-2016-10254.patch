From 191000fdedba3fafe4d5b8cddad3f3318b49c3fb Mon Sep 17 00:00:00 2001
From: Mark Wielaard <mjw@redhat.com>
Date: Wed, 26 Oct 2016 13:08:52 +0200
Subject: [PATCH] libelf: Always set ELF maxsize when reading an ELF file for
 sanity checks.

There are various sanity checks that depend on knowing the file size
of the underlying ELF file which we only used when mmapping the ELF file.
Although we probably won't crash if we use pread to try to read from
the file, we still might return completely bogus data structures. This
could cause us to malloc insane amounts of memory.

Always try to get the maxsize when unknown in elf_begin.c (read_file).

https://bugzilla.redhat.com/show_bug.cgi?id=1388057

Signed-off-by: Mark Wielaard <mjw@redhat.com>

Index: elfutils-0.166/libelf/elf_begin.c
===================================================================
--- elfutils-0.166.orig/libelf/elf_begin.c
+++ elfutils-0.166/libelf/elf_begin.c
@@ -606,22 +606,30 @@ read_file (int fildes, off_t offset, siz
 		  || cmd == ELF_C_WRITE_MMAP
 		  || cmd == ELF_C_READ_MMAP_PRIVATE);
 
-  if (use_mmap)
+  if (parent == NULL)
     {
-      if (parent == NULL)
+      if (maxsize == ~((size_t) 0))
 	{
-	  if (maxsize == ~((size_t) 0))
-	    {
-	      /* We don't know in the moment how large the file is.
-		 Determine it now.  */
-	      struct stat st;
+	  /* We don't know in the moment how large the file is.
+	     Determine it now.  */
+	  struct stat st;
 
-	      if (fstat (fildes, &st) == 0
-		  && (sizeof (size_t) >= sizeof (st.st_size)
-		      || st.st_size <= ~((size_t) 0)))
-		maxsize = (size_t) st.st_size;
-	    }
+	  if (fstat (fildes, &st) == 0
+	      && (sizeof (size_t) >= sizeof (st.st_size)
+		  || st.st_size <= ~((size_t) 0)))
+	    maxsize = (size_t) st.st_size;
+	}
+    }
+  else
+    {
+      /* The parent is already loaded.  Use it.  */
+      assert (maxsize != ~((size_t) 0));
+    }
 
+  if (use_mmap)
+    {
+      if (parent == NULL)
+	{
 	  /* We try to map the file ourself.  */
 	  map_address = mmap (NULL, maxsize, (cmd == ELF_C_READ_MMAP
 					      ? PROT_READ
@@ -636,9 +644,6 @@ read_file (int fildes, off_t offset, siz
 	}
       else
 	{
-	  /* The parent is already loaded.  Use it.  */
-	  assert (maxsize != ~((size_t) 0));
-
 	  map_address = parent->map_address;
 	}
     }
